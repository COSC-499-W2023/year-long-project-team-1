# Setting SHELL to bash allows bash commands to be executed by recipes.
# Options are set to exit when a recipe line exits non-zero or a piped command fails.
SHELL := /usr/bin/env bash -o pipefail
.SHELLFLAGS = -ec

# Image identifier
IMAGE_VERSION ?= 0.1.0-dev
IMAGE_NAME ?= privacypal
DEFAULT_NAMESPACE = ghcr.io/cosc-499-w2023
IMAGE_NAMESPACE ?= $(DEFAULT_NAMESPACE)

PRIVACYPAL_IMAGE ?= $(IMAGE_NAMESPACE)/$(IMAGE_NAME):$(IMAGE_VERSION)

# Tools
IMAGE_BUILDER ?= podman

##@ Build
.PHONY: oci-build
oci-build: ## Build the OCI image for web server.
	$(IMAGE_BUILDER) build -t $(PRIVACYPAL_IMAGE) -f ./Dockerfile .

##@ Smoketest

CONTAINER_NAME ?= privacypal
PORT ?= 8080
LOG_FILE ?= privacypal-run.log
PRIVACYPAL_AUTH_MANAGER ?= basic
PRIVACYPAL_DEBUG ?= true
PRIVACYPAL_PROCESSOR_URL = http://localhost:3000
DATABASE_URL = postgresql://privacypal:password@localhost:5432/privacypal

LOCAL_CONFIG_DIR ?= $(shell cd)\conf
LOCAL_INPUT_DIR ?= $(shell cd)\conf\input-videos
LOCAL_OUTPUT_DIR ?= $(shell cd)\conf\output-videos


.PHONY: create-dirs
create-dirs:
	if not exist "$(LOCAL_CONFIG_DIR)" mkdir "$(LOCAL_CONFIG_DIR)"
	if not exist "$(LOCAL_INPUT_DIR)" mkdir "$(LOCAL_INPUT_DIR)"
	if not exist "$(LOCAL_OUTPUT_DIR)" mkdir "$(LOCAL_OUTPUT_DIR)"

.PHONY: start-db
start-db: ## Start and initialze database instance for smoketest.
	$(MAKE) -C db -f Makefile-win start-db run

.PHONY: start-vidprocessor
start-vidprocessor:
	cmd /V /C "set LOCAL_INPUT_DIR=$(LOCAL_INPUT_DIR) && set LOCAL_OUTPUT_DIR=$(LOCAL_OUTPUT_DIR) && set DETACHED=true && $(MAKE) -C ../video-processing -f Makefile-win run"

.PHONY: pre-run
pre-run: create-dirs start-db start-vidprocessor ## Set up the environment for running web server.

.PHONY: run
run: pre-run ## Run the web server.
	$(IMAGE_BUILDER) run \
		--name "$(CONTAINER_NAME)" \
		--user 0 \
		--network host \
		-e NO_COLOR="true" \
		-e PORT=$(PORT) \
		-e AWS_ACCESS_KEY_ID="%AWS_ACCESS_KEY_ID%" \
		-e AWS_SECRET_ACCESS_KEY="%AWS_SECRET_ACCESS_KEY%" \
		-e AWS_SESSION_TOKEN="%AWS_SESSION_TOKEN%" \
		-e AWS_DEFAULT_REGION="ca-central-1" \
		-e PRIVACYPAL_CONFIG_DIR="/opt/privacypal" \
		-e PRIVACYPAL_INPUT_VIDEO_DIR="/opt/privacypal/input_videos" \
		-e PRIVACYPAL_OUTPUT_VIDEO_DIR="/opt/privacypal/output_videos" \
		-e PRIVACYPAL_AUTH_MANAGER="$(PRIVACYPAL_AUTH_MANAGER)" \
		-e PRIVACYPAL_DEBUG="$(PRIVACYPAL_DEBUG)" \
		-e DATABASE_URL="$(DATABASE_URL)" \
		-e PRIVACYPAL_PROCESSOR_URL="$(PRIVACYPAL_PROCESSOR_URL)" \
		-v "$(LOCAL_INPUT_DIR)":"/opt/privacypal/input_videos":z \
		-v "$(LOCAL_OUTPUT_DIR)":"/opt/privacypal/output_videos":z \
		-it --replace $(PRIVACYPAL_IMAGE) 2>&1
